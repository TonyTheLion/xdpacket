---
# multicast DNS mangling using new grammar
# in this example:
# eth0 == 192.168.1.1/24 -> client 192.168.1.20
# eth1 == 10.1.1.1/24 -> chromecast 10.1.1.20
xdpk:
  # field: a set of bytes to be hashed or written
  - field: ip proto
    offt: 25
    len: 1
  - field: ip src
    offt: 26
    len: 4
  - field: ip dst
    offt: 32
    len: 4
  - field: mdns rec
    offt: 377
    len: 2
  - field: mdns rec addr
    offt: -4
    len: 4

  - node: client unicast
    in: eth0
    match:
      - ip proto: 0x1  ## ICMP
      - ip src: 192.168.1.20
      - ip dst: 192.168.1.1
    xform:
      - set: {ip src: 10.1.1.1}
      - set: {ip dst: 10.1.1.20}
      - out: eth1

  - node: client 2 unicast
    in: eth0
    match:
      - ip proto: 0x1  ## ICMP
      - ip src: 192.168.1.21
      - ip dst: 192.168.1.1
    xform:
      - set: {ip src: 10.1.1.1}
      - set: {ip dst: 10.1.1.21}
      - out: eth1

  - node: chrome unicast
    in: eth1
    match:
      - ip src: 10.1.1.20
      - ip dst: 10.1.1.1
    xform:
      - set: {ip src: 192.168.1.20}
      - set: {ip dst: 192.168.1.1}
      - out: eth0

  - node: client mdns
    in: eth0
    match:
      - ip src: 192.168.1.20
      - ip dst: 224.0.0.251
    xform:
      - set: {ip src: 10.1.1.20}
      - out: eth1

  - node: chrome mdns A
    in: eth1
    match:
      - ip src: 10.1.1.20
      - ip dst: 224.0.0.251
      - mdns rec: 0x0001  # DNS A record
    xform:
      - set: {ip src: 192.168.1.20}
      - set: {mdns rec addr: 192.168.1.20}
      - out: eth0

  # MUST be matched AFTER preceding (more specific) 'A' rule
  - node: chrome mdns
    in: eth1
    match:
      - ip src: 10.1.1.20
      - ip dst: 224.0.0.251
    xform:
      - set: {ip src: 192.168.1.20}
      - out: eth0
